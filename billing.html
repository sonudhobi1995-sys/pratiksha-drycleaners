<script>
    let billItems = [];
    
    // üö© ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§°‡§ø‡§ú‡§ø‡§ü‡§≤ ‡§ï‡•ã‡§∞ ‡§ï‡§æ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§≤‡§ø‡§Ç‡§ï
    const scriptURL = "https://script.google.com/macros/s/AKfycbwVigQjXem0p3gBITdm6Iiwi8HBLWl-tf1AlmA-4eka_axmvMfqgzEoTKOBsVf97aSDdA/exec";

    // --- ‡§ï‡•â‡§®‡•ç‡§ü‡•à‡§ï‡•ç‡§ü ‡§™‡§ø‡§ï‡§∞ ‡§ú‡§æ‡§¶‡•Å‡§à ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® ---
    async function getContact(mobileId, nameId) {
        if (!('contacts' in navigator && 'ContactsManager' in window)) {
            return alert("‡§Ø‡§π ‡§´‡•Ä‡§ö‡§∞ ‡§ï‡•á‡§µ‡§≤ Android Chrome ‡§î‡§∞ HTTPS ‡§≤‡§ø‡§Ç‡§ï ‡§™‡§∞ ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§");
        }
        try {
            const props = ['name', 'tel'];
            const contacts = await navigator.contacts.select(props, {multiple: false});
            if (contacts.length > 0) {
                const contact = contacts[0];
                if (contact.tel && contact.tel.length > 0) {
                    let rawNum = contact.tel[0].replace(/\D/g, '');
                    document.getElementById(mobileId).value = rawNum.length > 10 ? rawNum.slice(-10) : rawNum;
                }
                if (contact.name && contact.name.length > 0) {
                    document.getElementById(nameId).value = contact.name[0];
                }
            }
        } catch (err) {
            console.log("Error: " + err.message);
        }
    }

    function addItem() {
        const name = document.getElementById('itemSelect').value;
        const service = document.getElementById('serviceType').value;
        const q = document.getElementById('qty').value;
        const r = document.getElementById('rate').value;
        if(!name || !q || !r) return alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Ç‡§∞‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§≠‡§∞‡•á‡§Ç");
        const total = q * r;
        billItems.push({name, service, q, r, total});
        render();
        document.getElementById('qty').value = "";
        document.getElementById('rate').value = "";
    }

    function render() {
        const body = document.querySelector('#billTable tbody');
        body.innerHTML = '';
        let grand = 0;
        billItems.forEach(i => {
            grand += i.total;
            body.innerHTML += `<tr><td>${i.name}<br><small>(${i.service})</small></td><td>${i.q}</td><td>‚Çπ${i.total}</td></tr>`;
        });
        document.getElementById('gTotal').innerText = `Total: ‚Çπ ${grand}`;
    }

    function sendWA() {
        const cName = document.getElementById('custName').value || "‡§®‡§Ø‡§æ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï";
        const mob = document.getElementById('custMobile').value;
        
        if(!mob || mob.length < 10) return alert("‡§∏‡§π‡•Ä ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§°‡§æ‡§≤‡•á‡§Ç");
        if(billItems.length === 0) return alert("‡§≤‡§ø‡§∏‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§Ü‡§á‡§ü‡§Æ ‡§ú‡•ã‡•ú‡•á‡§Ç");

        let grandTotal = 0;
        let detailsStr = "";
        
        // ‡§¨‡§ø‡§≤ ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡§®‡§æ (‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§ï‡•á ‡§≤‡§ø‡§è)
        billItems.forEach(i => {
            detailsStr += `${i.name}(${i.q}), `;
            grandTotal += i.total;
        });

        // üö© ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§ó‡•Ç‡§ó‡§≤ ‡§∂‡•Ä‡§ü (Digital Core) ‡§Æ‡•á‡§Ç ‡§≠‡•á‡§ú‡§®‡§æ
        fetch(`${scriptURL}?action=updateStatus&mobile=${mob}&status=Delivered&amount=${grandTotal}&details=${encodeURIComponent(detailsStr)}&paymentStatus=Paid`)
        .then(res => console.log("Data Sent to Core ‚úÖ"))
        .catch(err => console.error("Sync Error"));

        // ‡§µ‡•ç‡§π‡§æ‡§ü‡•ç‡§∏‡§è‡§™ ‡§Æ‡•à‡§∏‡•á‡§ú ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡§®‡§æ
        let msg = `*‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§°‡•ç‡§∞‡§æ‡§à ‡§ï‡•ç‡§≤‡•Ä‡§®‡§∞‡•ç‡§∏* üß∫‚ú®\n\n*‡§®‡§Æ‡§∏‡•ç‡§§‡•á ${cName},*\n‡§Ü‡§™‡§ï‡§æ ‡§°‡§ø‡§ú‡§ø‡§ü‡§≤ ‡§¨‡§ø‡§≤ ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•à:\n\n`;
        billItems.forEach(i => {
            msg += `‚Ä¢ ${i.name} (${i.service})\n  ${i.q} x ${i.r} = *‚Çπ${i.total}*\n\n`;
        });
        msg += `----------------------\n*‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø: ‚Çπ${grandTotal}*\n----------------------\n\n‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶! üôè‚ú®`;
        
        window.open(`https://wa.me/91${mob}?text=${encodeURIComponent(msg)}`, '_blank');
    }

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sww.js');
    }
</script>
