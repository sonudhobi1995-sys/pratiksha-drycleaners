<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pratiksha Billing | ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§¨‡§ø‡§≤‡§ø‡§Ç‡§ó</title>
    
    <link rel="manifest" href="manifest-billing.json">
    <meta name="theme-color" content="#FF8C00">
    <link rel="apple-touch-icon" href="logo.png">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --sun-orange: #FF8C00;
            --saturn-blue: #001F3F;
            --moon-white: #FFFFFF;
            --jupiter-yellow: #FFF9C4;
        }

        body { font-family: 'Inter', sans-serif; background: var(--moon-white); margin: 0; padding: 0; }
        
        .billing-header { 
            background: var(--saturn-blue); 
            color: white; padding: 20px; text-align: center; 
            border-radius: 0 0 30px 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .app-logo { width: 70px; height: 70px; background: white; border-radius: 50%; padding: 5px; border: 2px solid var(--sun-orange); object-fit: contain; }

        .container { padding: 20px; max-width: 500px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; border: 1px solid #eee; }
        
        h3 { margin-top: 0; color: var(--saturn-blue); border-bottom: 2px solid var(--sun-orange); display: inline-block; }
        
        .input-group { display: flex; gap: 8px; margin: 10px 0; }
        .input-group input { margin: 0; flex: 1; }
        .btn-contact { padding: 0 15px; border-radius: 12px; border: 1px solid #ddd; background: #fff; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; }

        input, select { width: 100%; padding: 12px; margin: 10px 0; border-radius: 12px; border: 1px solid #ddd; box-sizing: border-box; font-size: 1rem; }
        
        .btn-add { background: var(--saturn-blue); color: white; width: 100%; border: none; padding: 15px; border-radius: 12px; cursor: pointer; font-weight: bold; }
        .total-box { background: var(--jupiter-yellow); padding: 15px; border-radius: 15px; text-align: center; border: 2px dashed var(--sun-orange); margin-top: 15px; }
        
        .btn-wa { background: #25D366; color: white; width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: bold; margin-top: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-print { background: #333; color: white; width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: bold; margin-top: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: #f4f4f4; padding: 10px; text-align: left; font-size: 0.8rem; border: 1px solid #eee; }
        td { padding: 12px 10px; border-bottom: 1px solid #eee; font-size: 0.95rem; border: 1px solid #eee; }

        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; padding: 25px; box-sizing: border-box; }
            .no-print { display: none !important; }
            .total-box { border: 2px solid #000; background: none !important; margin-top: 20px; }
            table, th, td { border: 1px solid #000 !important; }
            #navgrahTop { display: block !important; text-align: center; font-size: 10px; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #000; padding-bottom: 5px; }
            #billShopTitle { display: block !important; text-align: center; margin-bottom: 15px; }
            #printFooter { display: block !important; text-align: center; margin-top: 20px; font-style: italic; font-size: 12px; }
        }
    </style>
</head>
<body>

<div class="billing-header no-print">
    <img src="logo.png" alt="PRATIKSHA" class="app-logo">
    <h1 style="margin:0; font-size: 1.3rem;">‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§¨‡§ø‡§≤‡§ø‡§Ç‡§ó ‡§ê‡§™</h1>
    <p style="margin:5px 0 0; font-size: 0.8rem; opacity: 0.8;">‡§∂‡•Å‡§ö‡§ø‡§§‡§æ ‡§î‡§∞ ‡§∞‡•Ç‡§π‡§æ‡§®‡•Ä ‡§∏‡•á‡§µ‡§æ</p>
</div>

<div class="container">
    <div class="card no-print">
        <h3>üë§ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§µ‡§ø‡§µ‡§∞‡§£</h3>
        <div class="input-group">
            <input type="tel" id="custMobile" placeholder="‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞">
            <button type="button" class="btn-contact" onclick="getContact('custMobile', 'custName')">üë§</button>
        </div>
        <input type="text" id="custName" placeholder="‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ ‡§®‡§æ‡§Æ">
    </div>

    <div class="card no-print">
        <h3>üß∫ ‡§Ü‡§á‡§ü‡§Æ ‡§ú‡•ã‡•ú‡•á‡§Ç</h3>
        <select id="itemSelect">
            <option value="">‡§ï‡§™‡•ú‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç</option>
            <option value="‡§∂‡§∞‡•ç‡§ü">‡§∂‡§∞‡•ç‡§ü</option>
            <option value="‡§™‡•á‡§Ç‡§ü/‡§ú‡•Ä‡§Ç‡§∏">‡§™‡•á‡§Ç‡§ü/‡§ú‡•Ä‡§Ç‡§∏</option>
            <option value="‡§∏‡§æ‡•ú‡•Ä">‡§∏‡§æ‡•ú‡•Ä</option>
            <option value="‡§∏‡•Ç‡§ü/‡§ï‡•Å‡§∞‡•ç‡§§‡§æ">‡§∏‡•Ç‡§ü/‡§ï‡•Å‡§∞‡•ç‡§§‡§æ</option>
            <option value="‡§ö‡§æ‡§¶‡§∞">‡§ö‡§æ‡§¶‡§∞</option>
            <option value="‡§ï‡§Ç‡§¨‡§≤">‡§ï‡§Ç‡§¨‡§≤</option>
            <option value="‡§™‡§∞‡•ç‡§¶‡•á">‡§™‡§∞‡•ç‡§¶‡•á</option>
            <option value="‡§Ö‡§®‡•ç‡§Ø">‡§Ö‡§®‡•ç‡§Ø</option>
        </select>
        <select id="serviceType">
            <option value="‡§™‡•ç‡§∞‡•á‡§∏">üí® ‡§™‡•ç‡§∞‡•á‡§∏</option>
            <option value="‡§∏‡•ç‡§ü‡•Ä‡§Æ ‡§™‡•ç‡§∞‡•á‡§∏">üí® ‡§∏‡•ç‡§ü‡•Ä‡§Æ ‡§™‡•ç‡§∞‡•á‡§∏</option>
            <option value="‡§ß‡•Å‡§≤‡§æ‡§à ‡§™‡•ç‡§∞‡•á‡§∏">üßº ‡§ß‡•Å‡§≤‡§æ‡§à ‡§™‡•ç‡§∞‡•á‡§∏</option>
            <option value="‡§°‡•ç‡§∞‡§æ‡§à ‡§ï‡•ç‡§≤‡•Ä‡§®‡§ø‡§Ç‡§ó">‚ú® ‡§°‡•ç‡§∞‡§æ‡§à ‡§ï‡•ç‡§≤‡•Ä‡§®‡§ø‡§Ç‡§ó</option>
        </select>
        <div style="display:flex; gap:10px;">
            <input type="number" id="qty" placeholder="‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ">
            <input type="number" id="rate" placeholder="‡§∞‡•á‡§ü ‚Çπ">
        </div>
        <button class="btn-add" onclick="addItem()">+ ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡•ú‡•á‡§Ç</button>
    </div>

    <div class="card" id="printArea">
        <div id="navgrahTop" style="display:none;">
            ‚òÄÔ∏è ‡§∏‡•Ç‡§∞‡•ç‡§Ø üåô ‡§ö‡§Ç‡§¶‡•ç‡§∞ üî• ‡§Æ‡§Ç‡§ó‡§≤ üåø ‡§¨‡•Å‡§ß üåü ‡§ó‡•Å‡§∞‡•Å ‚ú® ‡§∂‡•Å‡§ï‡•ç‡§∞ ü™ê ‡§∂‡§®‡§ø üåë ‡§∞‡§æ‡§π‡•Å ‚òÑÔ∏è ‡§ï‡•á‡§§‡•Å
        </div>

        <div id="billShopTitle" style="display:none; text-align:center;">
            <h1 style="margin:0; font-size: 24px;">PRATIKSHA DRYCLEANERS</h1>
            <p style="margin:3px 0; font-size: 13px;">‡§Ö‡§Ç‡§¨‡§æ‡§¨‡§æ‡•ú‡•Ä, ‡§ú‡§Ø‡§™‡•Å‡§∞ | ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤: 8440985969</p>
            <p style="font-size: 11px;">‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï: <span id="pDate"></span></p>
            <hr style="border: 0.5px solid #000;">
        </div>

        <table id="billTable">
            <thead><tr><th>‡§Ü‡§á‡§ü‡§Æ ‡§µ‡§ø‡§µ‡§∞‡§£</th><th>‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ</th><th>‡§ï‡•Å‡§≤</th></tr></thead>
            <tbody></tbody>
        </table>

        <div class="total-box">
            <h2 id="gTotal" style="margin:0;">Total: ‚Çπ 0</h2>
        </div>

        <div id="printFooter" style="display:none;">
            ‡•§‡•§ ‡§∂‡•Å‡§ö‡§ø‡§§‡§æ ‡§î‡§∞ ‡§∞‡•Ç‡§π‡§æ‡§®‡•Ä ‡§∏‡•á‡§µ‡§æ ‡§π‡•Ä ‡§π‡§Æ‡§æ‡§∞‡§æ ‡§∏‡§Ç‡§ï‡§≤‡•ç‡§™ ‡§π‡•à ‡•§‡•§
        </div>
        
        <button class="btn-wa no-print" id="waBtn" onclick="sendWA()">üì≤ ‡§µ‡•ç‡§π‡§æ‡§ü‡•ç‡§∏‡§è‡§™ ‡§î‡§∞ ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</button>
        <button class="btn-print no-print" onclick="printBill()">üñ®Ô∏è ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§∞‡§∏‡•Ä‡§¶</button>
    </div>
</div>

<script>
    let billItems = [];
    // ‡§Ü‡§™‡§ï‡§æ ‡§§‡§æ‡§ú‡§º‡§æ ‡§∞‡§æ‡§Æ‡§¨‡§æ‡§£ ‡§≤‡§ø‡§Ç‡§ï (V4 Fix)
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz1jvpgkduKi7HLUyt58iBHxUcbjtNg6I4qtqFV7y3MBemDzifY4sx5JmTckLVLwBAfBA/exec";

    async function getContact(mobileId, nameId) {
        if (!('contacts' in navigator)) return alert("Android Chrome ‡§™‡§∞ ‡§π‡•Ä ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡•á‡§ó‡§æ‡•§");
        try {
            const props = ['name', 'tel'];
            const contacts = await navigator.contacts.select(props, {multiple: false});
            if (contacts.length > 0) {
                const contact = contacts[0];
                if (contact.tel) {
                    let rawNum = contact.tel[0].replace(/\D/g, '');
                    document.getElementById(mobileId).value = rawNum.slice(-10);
                }
                if (contact.name) document.getElementById(nameId).value = contact.name[0];
            }
        } catch (err) { console.log(err); }
    }

    function addItem() {
        const item = document.getElementById('itemSelect').value;
        const service = document.getElementById('serviceType').value;
        const q = document.getElementById('qty').value;
        const r = document.getElementById('rate').value;
        if(!item || !q || !r) return alert("‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ ‡§î‡§∞ ‡§∞‡•á‡§ü ‡§≠‡§∞‡•á‡§Ç");
        billItems.push({name: `${item} (${service})`, q, r, total: q*r});
        render();
        document.getElementById('qty').value = "";
        document.getElementById('rate').value = "";
    }

    function render() {
        const body = document.querySelector('#billTable tbody');
        body.innerHTML = ''; let grand = 0;
        billItems.forEach(i => {
            grand += i.total;
            body.innerHTML += `<tr><td>${i.name}</td><td>${i.q}</td><td>‚Çπ${i.total}</td></tr>`;
        });
        document.getElementById('gTotal').innerText = `Total: ‚Çπ ${grand}`;
    }

    function printBill() {
        document.getElementById('pDate').innerText = new Date().toLocaleDateString('hi-IN');
        window.print();
    }

    function sendWA() {
        const mob = document.getElementById('custMobile').value;
        const btn = document.getElementById('waBtn');
        if(!mob || mob.length < 10) return alert("‡§∏‡§π‡•Ä ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§°‡§æ‡§≤‡•á‡§Ç");

        let grandTotal = 0;
        let msg = `*‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§°‡•ç‡§∞‡§æ‡§à ‡§ï‡•ç‡§≤‡•Ä‡§®‡§∞‡•ç‡§∏* üß∫‚ú®\n\n‡§Ü‡§™‡§ï‡§æ ‡§¨‡§ø‡§≤ ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•à:\n`;
        billItems.forEach(i => {
            msg += `‚Ä¢ ${i.name}: ${i.q} x ‚Çπ${i.r} = *‚Çπ${i.total}*\n`;
            grandTotal += i.total;
        });
        msg += `\n*‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø: ‚Çπ${grandTotal}*\n\n‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶! üôè`;

        btn.innerText = "‡§∏‡•á‡§µ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...";
        btn.disabled = true;

        // "Fire & Forget" ‡§∞‡§æ‡§Æ‡§¨‡§æ‡§£ ‡§§‡§∞‡•Ä‡§ï‡§æ (no-cors)
        const finalURL = `${SCRIPT_URL}?action=updateStatus&mobile=${mob}&amount=${grandTotal}&status=Delivered`;
        
        fetch(finalURL, { 
            method: 'GET',
            mode: 'no-cors' 
        });

        // ‡§ú‡§µ‡§æ‡§¨ ‡§ï‡§æ ‡§á‡§Ç‡§§‡§ú‡§º‡§æ‡§∞ ‡§ï‡§ø‡§è ‡§¨‡§ø‡§®‡§æ ‡§µ‡•ç‡§π‡§æ‡§ü‡•ç‡§∏‡§è‡§™ ‡§ñ‡•ã‡§≤‡•á‡§Ç
        setTimeout(() => {
            window.open(`https://wa.me/91${mob}?text=${encodeURIComponent(msg)}`, '_blank');
            alert("‡§¨‡§ø‡§≤ ‡§°‡•á‡§ü‡§æ ‡§≠‡•á‡§ú ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à! ‚úÖ");
            location.reload();
        }, 1500);
    }
</script>
</body>
</html>
