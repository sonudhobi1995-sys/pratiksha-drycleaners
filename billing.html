<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pratiksha Billing | рд╕реНрдорд╛рд░реНрдЯ рдмрд┐рд▓рд┐рдВрдЧ</title>
    
    <link rel="manifest" href="manifest-billing.json">
    <meta name="theme-color" content="#FF8C00">
    <link rel="apple-touch-icon" href="logo.png">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --sun: #FF8C00; --saturn: #001F3F; --jupiter: #FFF9C4; }
        body { font-family: 'Poppins', sans-serif; background: #f4f7f9; margin: 0; padding: 0; color: #333; }
        
        /* рд╣реЗрдбрд░ рдФрд░ рд▓реЛрдЧреЛ */
        .billing-header { 
            background: var(--saturn); color: white; padding: 25px 20px; text-align: center; 
            border-radius: 0 0 30px 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .app-logo { width: 55px; height: 55px; background: white; border-radius: 50%; padding: 5px; border: 2px solid var(--sun); margin-bottom: 8px; }

        .container { padding: 20px; max-width: 550px; margin: -25px auto 50px; }
        .card { background: white; padding: 22px; border-radius: 25px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        h3 { margin: 0 0 12px; color: var(--saturn); border-left: 4px solid var(--sun); padding-left: 10px; font-size: 1rem; }
        
        input, select { width: 100%; padding: 14px; margin: 8px 0; border-radius: 15px; border: 1px solid #eee; box-sizing: border-box; font-size: 1rem; outline: none; background: #f9f9f9; }
        
        /* рд╕реНрдорд╛рд░реНрдЯ рдмрдХрд╛рдпрд╛ рдЗрдирдкреБрдЯ */
        .balance-field { border: 2px solid #feb2b2 !important; background: #fff5f5 !important; color: #c53030; font-weight: bold; }
        .loader { font-size: 0.7rem; color: #999; margin-left: 10px; display: none; }

        .btn-add { background: var(--saturn); color: white; width: 100%; border: none; padding: 16px; border-radius: 15px; cursor: pointer; font-weight: 700; margin-top: 10px; }
        .total-box { background: var(--jupiter); padding: 20px; border-radius: 20px; text-align: center; border: 2px dashed var(--sun); margin-top: 15px; }
        
        .btn-wa { background: #25D366; color: white; width: 100%; padding: 18px; border: none; border-radius: 18px; font-weight: 700; margin-top: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 1.1rem; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        td { padding: 12px 8px; border-bottom: 1px solid #f0f0f0; font-size: 0.95rem; }

        /* рдкреНрд░рд┐рдВрдЯ рд╕реЗрдЯрд┐рдВрдЧреНрд╕ (рдЕрддреНрдпрдзрд┐рдХ рдорд╣рддреНрд╡рдкреВрд░реНрдг) */
        @media print {
            .no-print { display: none !important; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; visibility: visible; }
            #navgrahTop { display: block !important; text-align: center; font-size: 12px; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #000; padding-bottom: 5px; }
            #billShopTitle { display: block !important; text-align: center; }
            #printFooter { display: block !important; text-align: center; margin-top: 40px; font-weight: bold; font-size: 14px; border-top: 1px solid #000; padding-top: 10px; }
            .total-box { border: 2px solid #000; background: none !important; color: #000; }
        }
    </style>
</head>
<body>

<div class="billing-header no-print">
    <img src="logo.png" alt="P" class="app-logo">
    <h1 style="margin:0; font-size: 1.4rem; letter-spacing: 1px;">PRATIKSHA DIGITAL</h1>
    <p style="margin:4px 0 0; font-size: 0.75rem; opacity: 0.8;">редред рд╢реБрдЪрд┐рддрд╛ рдФрд░ рд░реВрд╣рд╛рдиреА рд╕реЗрд╡рд╛ редред</p>
</div>

<div class="container">
    <div class="card no-print">
        <h3>ЁЯСд рдЧреНрд░рд╛рд╣рдХ рд╡рд┐рд╡рд░рдг</h3>
        <div style="display:flex; gap:8px;">
            <input type="tel" id="custMobile" placeholder="рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░" onchange="fetchOldBalance()">
            <button type="button" onclick="getContact()" style="padding:0 15px; border-radius:15px; border:1px solid #ddd; background:white; font-size:1.2rem;">ЁЯСд</button>
        </div>
        <div id="loading" class="loader">рдмрдХрд╛рдпрд╛ рдЪреЗрдХ рд╣реЛ рд░рд╣рд╛ рд╣реИ...</div>
        <input type="text" id="custName" placeholder="рдЧреНрд░рд╛рд╣рдХ рдХрд╛ рдирд╛рдо">
        
        <label style="font-size: 0.75rem; color: #e74c3c; font-weight: bold; margin-left: 5px;">тЪая╕П рдкрд┐рдЫрд▓рд╛ рдмрдХрд╛рдпрд╛ (Old Balance):</label>
        <input type="number" id="manualBalance" class="balance-field" placeholder="тВ╣ 0" oninput="render()">
    </div>

    <div class="card no-print">
        <h3>ЁЯз║ рд╕реЗрд╡рд╛ рдЪрдпрди</h3>
        <select id="itemSelect">
            <option value="">рдХрдкрдбрд╝рд╛ рдЪреБрдиреЗрдВ</option>
            <option value="рд░реЗрдЧреБрд▓рд░ рдХрдкрдбрд╝реЗ">ЁЯзе рд░реЗрдЧреБрд▓рд░ рдХрдкрдбрд╝реЗ</option>
            <option value="рд╢рд░реНрдЯ">рд╢рд░реНрдЯ</option>
            <option value="рд╕рд╛рдбрд╝реА">рд╕рд╛рдбрд╝реА</option>
            <option value="рд╕реВрдЯ/рдХреБрд░реНрддрд╛">рд╕реВрдЯ/рдХреБрд░реНрддрд╛</option>
            <option value="рдХрдВрдмрд▓/рдЪрд╛рджрд░">рдХрдВрдмрд▓/рдЪрд╛рджрд░</option>
            <option value="рдЕрдиреНрдп">рдЕрдиреНрдп</option>
        </select>
        <select id="serviceType">
            <option value="рдкреНрд░реЗрд╕">ЁЯТи рдкреНрд░реЗрд╕</option>
            <option value="рд╕реНрдЯреАрдо рдкреНрд░реЗрд╕">ЁЯТи рд╕реНрдЯреАрдо рдкреНрд░реЗрд╕</option>
            <option value="рдзреБрд▓рд╛рдИ рдкреНрд░реЗрд╕">ЁЯз╝ рдзреБрд▓рд╛рдИ рдкреНрд░реЗрд╕</option>
            <option value="рдбреНрд░рд╛рдИ рдХреНрд▓реАрдирд┐рдВрдЧ">тЬи рдбреНрд░рд╛рдИ рдХреНрд▓реАрдирд┐рдВрдЧ</option>
        </select>
        <div style="display:flex; gap:10px;">
            <input type="number" id="qty" placeholder="рдирдЧ">
            <input type="number" id="rate" placeholder="рд░реЗрдЯ тВ╣">
        </div>
        <button class="btn-add" onclick="addItem()">+ рд▓рд┐рд╕реНрдЯ рдореЗрдВ рдЬреЛрдбрд╝реЗрдВ</button>
    </div>

    <div class="card" id="printArea">
        <div id="navgrahTop" style="display:none;">тШАя╕П рд╕реВрд░реНрдп ЁЯМЩ рдЪрдВрджреНрд░ ЁЯФе рдордВрдЧрд▓ ЁЯМ┐ рдмреБрдз ЁЯМЯ рдЧреБрд░реБ тЬи рд╢реБрдХреНрд░ ЁЯкР рд╢рдирд┐ ЁЯМС рд░рд╛рд╣реБ тШДя╕П рдХреЗрддреБ</div>
        <div id="billShopTitle" style="display:none;">
            <h1 style="margin:0; font-size: 22px;">PRATIKSHA DRYCLEANERS</h1>
            <p style="margin:3px 0; font-size: 12px;">рдЕрдВрдмрд╛рдмрд╛рдбрд╝реА, рдЬрдпрдкреБрд░ | рдореЛ: 8440985969</p>
            <hr>
        </div>

        <table id="billTable"><tbody></tbody></table>

        <div class="total-box">
            <h2 id="gTotal" style="margin:0; font-size: 1.6rem;">Total: тВ╣ 0</h2>
        </div>

        <div id="printFooter" style="display:none;">
            редред рд╢реБрдЪрд┐рддрд╛ рдФрд░ рд░реВрд╣рд╛рдиреА рд╕реЗрд╡рд╛ рд╣реА рд╣рдорд╛рд░рд╛ рд╕рдВрдХрд▓реНрдк рд╣реИ редред
        </div>
        
        <button class="btn-wa no-print" id="waBtn" onclick="sendWA()">ЁЯУ▓ рд╡реНрд╣рд╛рдЯреНрд╕рдПрдк рдФрд░ рд╕реЗрд╡ рдХрд░реЗрдВ</button>
        <button class="no-print" onclick="window.print()" style="width:100%; background:none; border:1px solid #ccc; margin-top:10px; padding:10px; border-radius:12px; cursor:pointer;">ЁЯЦия╕П рд░рд╕реАрдж рдкреНрд░рд┐рдВрдЯ рдХрд░реЗрдВ</button>
    </div>
</div>

<script>
    let billItems = [];
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx-Cu2CNgnLn6685hq40wxSW1AzK5fXJx91fDUGVEJvhvq8eDxRSZ7fhKDFrCCT2p8/exec";

    async function fetchOldBalance() {
        const mob = document.getElementById('custMobile').value;
        const loader = document.getElementById('loading');
        if(mob.length < 10) return;
        loader.style.display = 'block';
        try {
            const res = await fetch(`${SCRIPT_URL}?action=getBalance&mobile=${mob}`);
            const data = await res.json();
            if(data.balance) {
                document.getElementById('manualBalance').value = data.balance;
                render();
            }
        } catch (e) { console.log("Balance Error"); }
        loader.style.display = 'none';
    }

    async function getContact() {
        if (!('contacts' in navigator)) return alert("Mobile Chrome рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред");
        try {
            const contacts = await navigator.contacts.select(['name', 'tel'], {multiple: false});
            if (contacts.length > 0) {
                if (contacts[0].tel) {
                    document.getElementById('custMobile').value = contacts[0].tel[0].replace(/\D/g, '').slice(-10);
                    fetchOldBalance();
                }
                if (contacts[0].name) document.getElementById('custName').value = contacts[0].name[0];
            }
        } catch (err) {}
    }

    function addItem() {
        const item = document.getElementById('itemSelect').value;
        const service = document.getElementById('serviceType').value;
        const q = document.getElementById('qty').value;
        const r = document.getElementById('rate').value;
        if(!item || !q || !r) return alert("рд╕рдВрдЦреНрдпрд╛ рдФрд░ рд░реЗрдЯ рднрд░реЗрдВ");
        billItems.push({name: `${item} (${service})`, q, r, total: q*r});
        render();
        document.getElementById('qty').value = "";
    }

    function render() {
        const body = document.querySelector('#billTable tbody');
        const manualBal = parseFloat(document.getElementById('manualBalance').value) || 0;
        body.innerHTML = ''; let currentTotal = 0;
        billItems.forEach(i => {
            currentTotal += i.total;
            body.innerHTML += `<tr><td>${i.name} (${i.q} рдирдЧ)</td><td style="text-align:right; font-weight:bold;">тВ╣${i.total}</td></tr>`;
        });
        if(manualBal > 0) {
            body.innerHTML += `<tr style="color:red; font-weight:bold;"><td>рдкрд┐рдЫрд▓рд╛ рдмрдХрд╛рдпрд╛ (Old Balance)</td><td style="text-align:right;">+ тВ╣${manualBal}</td></tr>`;
        }
        document.getElementById('gTotal').innerText = `Total: тВ╣ ${currentTotal + manualBal}`;
    }

    function sendWA() {
        const mob = document.getElementById('custMobile').value;
        const name = document.getElementById('custName').value;
        const manualBal = parseFloat(document.getElementById('manualBalance').value) || 0;
        const btn = document.getElementById('waBtn');
        if(!mob || mob.length < 10) return alert("рдирдВрдмрд░ рд╕рд╣реА рдХрд░реЗрдВ");

        let currentTotal = 0;
        let itemDetails = "";
        let msg = `*рдкреНрд░рддреАрдХреНрд╖рд╛ рдбреНрд░рд╛рдИ рдХреНрд▓реАрдирд░реНрд╕* тЬиЁЯз║\n`;
        msg += `_рдЕрдВрдмрд╛рдмрд╛рдбрд╝реА, рдЬрдпрдкреБрд░ | 8440985969_\n\n`;
        msg += `*ЁЯЩП "рд╡рд╕реНрддреНрд░ рд╡реНрдпрдХреНрддрд┐рддреНрд╡ рдХрд╛ рджрд░реНрдкрдг рд╣реИрдВ, рдЗрдиреНрд╣реЗрдВ рд╢реБрдЪрд┐рддрд╛ рд╕реЗ рдирд┐рдЦрд╛рд░рдирд╛ рд╣рдорд╛рд░рд╛ 'рдЛрдгрд╛рдиреБрдмрдВрдз' рд╣реИред" ЁЯЩП*\n\n`;
        msg += `*рдЧреНрд░рд╛рд╣рдХ:* ${name}\n--------------------------\n`;
        
        billItems.forEach(i => {
            msg += `тАв ${i.name}: ${i.q} рдирдЧ = *тВ╣${i.total}*\n`;
            itemDetails += `${i.name} (${i.q}), `;
            currentTotal += i.total;
        });

        if(manualBal > 0) {
            msg += `--------------------------\nрдирдпрд╛ рдмрд┐рд▓: тВ╣${currentTotal}\nрдкрд┐рдЫрд▓рд╛ рдмрдХрд╛рдпрд╛: *тВ╣${manualBal}*\n`;
        }
        const finalAmount = currentTotal + manualBal;
        msg += `--------------------------\n*рдХреБрд▓ рджреЗрдп рд░рд╛рд╢рд┐: тВ╣${finalAmount}*\n\nредред рд╢реБрдЪрд┐рддрд╛ рдФрд░ рд░реВрд╣рд╛рдиреА рд╕реЗрд╡рд╛ рд╣реА рд╣рдорд╛рд░рд╛ рд╕рдВрдХрд▓реНрдк рд╣реИ редред`;

        btn.innerText = "рд╕реБрд░рдХреНрд╖рд┐рдд рд╕реЗрд╡ рд╣реЛ рд░рд╣рд╛ рд╣реИ... тП│";
        btn.disabled = true;

        const finalURL = `${SCRIPT_URL}?action=addBill&mobile=${mob}&name=${encodeURIComponent(name)}&amount=${finalAmount}&details=${encodeURIComponent(itemDetails)}&mode=Cash`;
        fetch(finalURL, { method: 'GET', mode: 'no-cors' });

        setTimeout(() => {
            window.open(`https://wa.me/91${mob}?text=${encodeURIComponent(msg)}`, '_blank');
            alert("рдбреЗрдЯрд╛ рд╕реБрд░рдХреНрд╖рд┐рдд рд╕реЗрд╡ рд╣реЛ рдЧрдпрд╛ рд╣реИ! тЬЕ");
            location.reload();
        }, 1500);
    }
</script>
</body>
</html>
