<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pratiksha Billing | ‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§¨‡§ø‡§≤‡§ø‡§Ç‡§ó</title>
    
    <link rel="manifest" href="manifest-billing.json">
    <meta name="theme-color" content="#FF8C00">
    <link rel="apple-touch-icon" href="logo.png">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --sun: #FF8C00; --saturn: #001F3F; --jupiter: #FFF9C4; }
        body { font-family: 'Poppins', sans-serif; background: #f4f7f9; margin: 0; padding: 0; color: #333; }
        
        /* ‡§π‡•á‡§°‡§∞ ‡§î‡§∞ ‡§≤‡•ã‡§ó‡•ã */
        .billing-header { 
            background: var(--saturn); color: white; padding: 25px 20px; text-align: center; 
            border-radius: 0 0 30px 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .app-logo { width: 55px; height: 55px; background: white; border-radius: 50%; padding: 5px; border: 2px solid var(--sun); margin-bottom: 8px; }

        .container { padding: 20px; max-width: 550px; margin: -25px auto 50px; }
        .card { background: white; padding: 22px; border-radius: 25px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        h3 { margin: 0 0 12px; color: var(--saturn); border-left: 4px solid var(--sun); padding-left: 10px; font-size: 1rem; }
        
        input, select { width: 100%; padding: 14px; margin: 8px 0; border-radius: 15px; border: 1px solid #eee; box-sizing: border-box; font-size: 1rem; outline: none; background: #f9f9f9; }
        
        /* ‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§á‡§®‡§™‡•Å‡§ü */
        .balance-field { border: 2px solid #feb2b2 !important; background: #fff5f5 !important; color: #c53030; font-weight: bold; }
        .loader { font-size: 0.7rem; color: #999; margin-left: 10px; display: none; }

        .btn-add { background: var(--saturn); color: white; width: 100%; border: none; padding: 16px; border-radius: 15px; cursor: pointer; font-weight: 700; margin-top: 10px; }
        .total-box { background: var(--jupiter); padding: 20px; border-radius: 20px; text-align: center; border: 2px dashed var(--sun); margin-top: 15px; }
        
        .btn-wa { background: #25D366; color: white; width: 100%; padding: 18px; border: none; border-radius: 18px; font-weight: 700; margin-top: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 1.1rem; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        td { padding: 12px 8px; border-bottom: 1px solid #f0f0f0; font-size: 0.95rem; }

        /* ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ (‡§Ö‡§§‡•ç‡§Ø‡§ß‡§ø‡§ï ‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£) */
        @media print {
            .no-print { display: none !important; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; visibility: visible; }
            #navgrahTop { display: block !important; text-align: center; font-size: 12px; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #000; padding-bottom: 5px; }
            #billShopTitle { display: block !important; text-align: center; }
            #printFooter { display: block !important; text-align: center; margin-top: 40px; font-weight: bold; font-size: 14px; border-top: 1px solid #000; padding-top: 10px; }
            .total-box { border: 2px solid #000; background: none !important; color: #000; }
        }
    </style>
</head>
<body>

<div class="billing-header no-print">
    <img src="logo.png" alt="P" class="app-logo">
    <h1 style="margin:0; font-size: 1.4rem; letter-spacing: 1px;">PRATIKSHA DIGITAL</h1>
    <p style="margin:4px 0 0; font-size: 0.75rem; opacity: 0.8;">‡•§‡•§ ‡§∂‡•Å‡§ö‡§ø‡§§‡§æ ‡§î‡§∞ ‡§∞‡•Ç‡§π‡§æ‡§®‡•Ä ‡§∏‡•á‡§µ‡§æ ‡•§‡•§</p>
</div>

<div class="container">
    <div class="card no-print">
        <h3>üë§ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§µ‡§ø‡§µ‡§∞‡§£</h3>
        <div style="display:flex; gap:8px;">
            <input type="tel" id="custMobile" placeholder="‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞" onchange="fetchOldBalance()">
            <button type="button" onclick="getContact()" style="padding:0 15px; border-radius:15px; border:1px solid #ddd; background:white; font-size:1.2rem;">üë§</button>
        </div>
        <div id="loading" class="loader">‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§ö‡•á‡§ï ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</div>
        <input type="text" id="custName" placeholder="‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ ‡§®‡§æ‡§Æ">
        
        <label style="font-size: 0.75rem; color: #e74c3c; font-weight: bold; margin-left: 5px;">‚ö†Ô∏è ‡§™‡§ø‡§õ‡§≤‡§æ ‡§¨‡§ï‡§æ‡§Ø‡§æ (Old Balance):</label>
        <input type="number" id="manualBalance" class="balance-field" placeholder="‚Çπ 0" oninput="render()">
    </div>

    <div class="card no-print">
        <h3>üß∫ ‡§∏‡•á‡§µ‡§æ ‡§ö‡§Ø‡§®</h3>
        <select id="itemSelect">
            <option value="">‡§ï‡§™‡§°‡§º‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç</option>
            <option value="‡§∞‡•á‡§ó‡•Å‡§≤‡§∞ ‡§ï‡§™‡§°‡§º‡•á">üß• ‡§∞‡•á‡§ó‡•Å‡§≤‡§∞ ‡§ï‡§™‡§°‡§º‡•á</option>
            <option value="‡§∂‡§∞‡•ç‡§ü">‡§∂‡§∞‡•ç‡§ü</option>
            <option value="‡§∏‡§æ‡§°‡§º‡•Ä">‡§∏‡§æ‡§°‡§º‡•Ä</option>
            <option value="‡§∏‡•Ç‡§ü/‡§ï‡•Å‡§∞‡•ç‡§§‡§æ">‡§∏‡•Ç‡§ü/‡§ï‡•Å‡§∞‡•ç‡§§‡§æ</option>
            <option value="‡§ï‡§Ç‡§¨‡§≤/‡§ö‡§æ‡§¶‡§∞">‡§ï‡§Ç‡§¨‡§≤/‡§ö‡§æ‡§¶‡§∞</option>
            <option value="‡§Ö‡§®‡•ç‡§Ø">‡§Ö‡§®‡•ç‡§Ø</option>
        </select>
        <select id="serviceType">
            <option value="‡§™‡•ç‡§∞‡•á‡§∏">üí® ‡§™‡•ç‡§∞‡•á‡§∏</option>
            <option value="‡§∏‡•ç‡§ü‡•Ä‡§Æ ‡§™‡•ç‡§∞‡•á‡§∏">üí® ‡§∏‡•ç‡§ü‡•Ä‡§Æ ‡§™‡•ç‡§∞‡•á‡§∏</option>
            <option value="‡§ß‡•Å‡§≤‡§æ‡§à ‡§™‡•ç‡§∞‡•á‡§∏">üßº ‡§ß‡•Å‡§≤‡§æ‡§à ‡§™‡•ç‡§∞‡•á‡§∏</option>
            <option value="‡§°‡•ç‡§∞‡§æ‡§à ‡§ï‡•ç‡§≤‡•Ä‡§®‡§ø‡§Ç‡§ó">‚ú® ‡§°‡•ç‡§∞‡§æ‡§à ‡§ï‡•ç‡§≤‡•Ä‡§®‡§ø‡§Ç‡§ó</option>
        </select>
        <div style="display:flex; gap:10px;">
            <input type="number" id="qty" placeholder="‡§®‡§ó">
            <input type="number" id="rate" placeholder="‡§∞‡•á‡§ü ‚Çπ">
        </div>
        <button class="btn-add" onclick="addItem()">+ ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>
    </div>

    <div class="card" id="printArea">
        <div id="navgrahTop" style="display:none;">‚òÄÔ∏è ‡§∏‡•Ç‡§∞‡•ç‡§Ø üåô ‡§ö‡§Ç‡§¶‡•ç‡§∞ üî• ‡§Æ‡§Ç‡§ó‡§≤ üåø ‡§¨‡•Å‡§ß üåü ‡§ó‡•Å‡§∞‡•Å ‚ú® ‡§∂‡•Å‡§ï‡•ç‡§∞ ü™ê ‡§∂‡§®‡§ø üåë ‡§∞‡§æ‡§π‡•Å ‚òÑÔ∏è ‡§ï‡•á‡§§‡•Å</div>
        <div id="billShopTitle" style="display:none;">
            <h1 style="margin:0; font-size: 22px;">PRATIKSHA DRYCLEANERS</h1>
            <p style="margin:3px 0; font-size: 12px;">‡§Ö‡§Ç‡§¨‡§æ‡§¨‡§æ‡§°‡§º‡•Ä, ‡§ú‡§Ø‡§™‡•Å‡§∞ | ‡§Æ‡•ã: 7740870095/8947985446/7740870098</p>
            <hr>
        </div>

        <table id="billTable"><tbody></tbody></table>

        <div class="total-box">
            <h2 id="gTotal" style="margin:0; font-size: 1.6rem;">Total: ‚Çπ 0</h2>
        </div>

        <div id="printFooter" style="display:none;">
            ‡•§‡•§ ‡§∂‡•Å‡§ö‡§ø‡§§‡§æ ‡§î‡§∞ ‡§∞‡•Ç‡§π‡§æ‡§®‡•Ä ‡§∏‡•á‡§µ‡§æ ‡§π‡•Ä ‡§π‡§Æ‡§æ‡§∞‡§æ ‡§∏‡§Ç‡§ï‡§≤‡•ç‡§™ ‡§π‡•à ‡•§‡•§
        </div>
        
        <button class="btn-wa no-print" id="waBtn" onclick="sendWA()">üì≤ ‡§µ‡•ç‡§π‡§æ‡§ü‡•ç‡§∏‡§è‡§™ ‡§î‡§∞ ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</button>
        <button class="no-print" onclick="window.print()" style="width:100%; background:none; border:1px solid #ccc; margin-top:10px; padding:10px; border-radius:12px; cursor:pointer;">üñ®Ô∏è ‡§∞‡§∏‡•Ä‡§¶ ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
    </div>
</div>

<script>
    let billItems = [];
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx-Cu2CNgnLn6685hq40wxSW1AzK5fXJx91fDUGVEJvhvq8eDxRSZ7fhKDFrCCT2p8/exec";

    async function fetchOldBalance() {
        const mob = document.getElementById('custMobile').value;
        const loader = document.getElementById('loading');
        if(mob.length < 10) return;
        loader.style.display = 'block';
        try {
            const res = await fetch(`${SCRIPT_URL}?action=getBalance&mobile=${mob}`);
            const data = await res.json();
            if(data.balance) {
                document.getElementById('manualBalance').value = data.balance;
                render();
            }
        } catch (e) { console.log("Balance Error"); }
        loader.style.display = 'none';
    }

    async function getContact() {
        if (!('contacts' in navigator)) return alert("Mobile Chrome ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç‡•§");
        try {
            const contacts = await navigator.contacts.select(['name', 'tel'], {multiple: false});
            if (contacts.length > 0) {
                if (contacts[0].tel) {
                    document.getElementById('custMobile').value = contacts[0].tel[0].replace(/\D/g, '').slice(-10);
                    fetchOldBalance();
                }
                if (contacts[0].name) document.getElementById('custName').value = contacts[0].name[0];
            }
        } catch (err) {}
    }

    function addItem() {
        const item = document.getElementById('itemSelect').value;
        const service = document.getElementById('serviceType').value;
        const q = document.getElementById('qty').value;
        const r = document.getElementById('rate').value;
        if(!item || !q || !r) return alert("‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ ‡§î‡§∞ ‡§∞‡•á‡§ü ‡§≠‡§∞‡•á‡§Ç");
        billItems.push({name: `${item} (${service})`, q, r, total: q*r});
        render();
        document.getElementById('qty').value = "";
    }

    function render() {
        const body = document.querySelector('#billTable tbody');
        const manualBal = parseFloat(document.getElementById('manualBalance').value) || 0;
        body.innerHTML = ''; let currentTotal = 0;
        billItems.forEach(i => {
            currentTotal += i.total;
            body.innerHTML += `<tr><td>${i.name} (${i.q} ‡§®‡§ó)</td><td style="text-align:right; font-weight:bold;">‚Çπ${i.total}</td></tr>`;
        });
        if(manualBal > 0) {
            body.innerHTML += `<tr style="color:red; font-weight:bold;"><td>‡§™‡§ø‡§õ‡§≤‡§æ ‡§¨‡§ï‡§æ‡§Ø‡§æ (Old Balance)</td><td style="text-align:right;">+ ‚Çπ${manualBal}</td></tr>`;
        }
        document.getElementById('gTotal').innerText = `Total: ‚Çπ ${currentTotal + manualBal}`;
    }

    function sendWA() {
        const mob = document.getElementById('custMobile').value;
        const name = document.getElementById('custName').value;
        const manualBal = parseFloat(document.getElementById('manualBalance').value) || 0;
        const btn = document.getElementById('waBtn');
        if(!mob || mob.length < 10) return alert("‡§®‡§Ç‡§¨‡§∞ ‡§∏‡§π‡•Ä ‡§ï‡§∞‡•á‡§Ç");

        let currentTotal = 0;
        let itemDetails = "";
        let msg = `*‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§°‡•ç‡§∞‡§æ‡§à ‡§ï‡•ç‡§≤‡•Ä‡§®‡§∞‡•ç‡§∏* ‚ú®üß∫\n`;
        msg += `_‡§Ö‡§Ç‡§¨‡§æ‡§¨‡§æ‡§°‡§º‡•Ä, ‡§ú‡§Ø‡§™‡•Å‡§∞ | 8947985446/7740870095/7740870098_\n\n`;
        msg += `*üôè‡§®‡§Æ‡§∏‡•ç‡§§‡•áüôè*\n\n`;
        msg += `*üôè "‡§µ‡§∏‡•ç‡§§‡•ç‡§∞ ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§§‡•ç‡§µ ‡§ï‡§æ ‡§¶‡§∞‡•ç‡§™‡§£ ‡§π‡•à‡§Ç‡•§" üôè*\n\n`;
        msg += `*‡§ó‡•ç‡§∞‡§æ‡§π‡§ï:* ${name}\n--------------------------\n`;
        
        billItems.forEach(i => {
            msg += `‚Ä¢ ${i.name}: ${i.q} ‡§®‡§ó = *‚Çπ${i.total}*\n`;
            itemDetails += `${i.name} (${i.q}), `;
            currentTotal += i.total;
        });

        if(manualBal > 0) {
            msg += `--------------------------\n‡§®‡§Ø‡§æ ‡§¨‡§ø‡§≤: ‚Çπ${currentTotal}\n‡§™‡§ø‡§õ‡§≤‡§æ ‡§¨‡§ï‡§æ‡§Ø‡§æ: *‚Çπ${manualBal}*\n`;
        }
        const finalAmount = currentTotal + manualBal;
        msg += `--------------------------\n*‡§ï‡•Å‡§≤ ‡§¶‡•á‡§Ø ‡§∞‡§æ‡§∂‡§ø: ‚Çπ${finalAmount}*\n\n‡•§‡•§ ‡§∂‡•Å‡§ö‡§ø‡§§‡§æ ‡§î‡§∞ ‡§∞‡•Ç‡§π‡§æ‡§®‡•Ä ‡§∏‡•á‡§µ‡§æ ‡§π‡•Ä ‡§π‡§Æ‡§æ‡§∞‡§æ ‡§∏‡§Ç‡§ï‡§≤‡•ç‡§™ ‡§π‡•à ‡•§‡•§`;

        btn.innerText = "‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§∏‡•á‡§µ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à... ‚è≥";
        btn.disabled = true;

        const finalURL = `${SCRIPT_URL}?action=addBill&mobile=${mob}&name=${encodeURIComponent(name)}&amount=${finalAmount}&details=${encodeURIComponent(itemDetails)}&mode=Cash`;
        fetch(finalURL, { method: 'GET', mode: 'no-cors' });

        setTimeout(() => {
            window.open(`https://wa.me/91${mob}?text=${encodeURIComponent(msg)}`, '_blank');
            alert("‡§°‡•á‡§ü‡§æ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à! ‚úÖ");
            location.reload();
        }, 1500);
    }
</script>
</body>
</html>
